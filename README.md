  # Переопределение версий зависимостей с помощью "overrides" в package.json #

  Зачастую в проекте возникает необходимость изменить версию той или иной библиотеки. Это может быть связано с тем, что в пакете обнаружен
баг или уязвимость и нужно установить либо предшествующую версию, в которой этих проблем нет, либо вариант библиотеки уже с исправлениями. Также возможно необходимо
использовать функционал, который появился (либо еще  не убран) из какой-то конкретной версии библиотеки. Наконец порой необходимо работать с предрелизными версиями пакетов.
  Конечно все пакетные менеджеры позволяют установить конкретную версию библиотеки. Однако нередко тот или иной пакет встречается в дереве зависимостей несколько раз:

```javascript
  // package.lock.json
  "some-components": {
    ...
    "requires": {
      ...
      "some-ui": "^1.1.0"
    }
  },
  "some-forms": {
    ...
    "requires": {
      ...
      "some-ui": "^1.2.0"
    }
  },
  "some-ui": {
    "version": "1.2.0-rc23"
    ...
  }
```

  Здесь у нас сразу 3 версии библиотеки `some-ui`. Это может привести к проблемам с совместимостью, если API или поведение между версиями отличаются. Это особенно критично для библиотек, которые
должны быть в единственном экземпляре (например, `react`). К слову сказать, даже если бы в примере выше нам не надо было бы использовать предрелизную версию `1.2.0-rc23` пакета `some-ui`,
все равно мог встать вопрос обеспечения совместимости библиотек `some-components` и `some-forms`. Даже если есть доступ к этим библиотекам, менять версии зависимостей непосредственно в них каждый раз очень неудобно - возникает необходимость новых публикаций. Ну и естественно доступ к разработке и публикации есть далеко не всегда.
  В этой ситуации может выручить поле `overrides` в `package.json` - свойство, позволяющее явно указать какую версию библиотеки использовать в дереве зависимостей, даже если эта версия отличается
  от той, что указана в исходных пакетах, которое появилось в `npm` в версии `8.3.0`. Аналогичным образом работает поле `resolutions` для `yarn`. Есть похожий функционал и у `pnpm` - свойство `overrides`.

  Итак, необходимо указать нужную версию:

```javascript
  // package.json
  "overrides": {
    "some-ui": "1.2.0-rc23"
  }
```
  или
```javascript
  // package.json
  "resolutions": {
    "some-ui": "1.2.0-rc23"
  }
```
  или 
```javascript
  // package.json
  "pnpm": {
    "overrides": {
      "some-ui": "1.2.0-rc23"
    }
  }
```
  А затем переустановить зависимости.

Но есть несколько нюансов.

Во-первых, пакетные менеджеры учитывают только "свои" поля в `package.json`. То есть `yarn` будет игнорировать свойство `overrides`, а `npm` пропустит поле `resolutions`. 
Это ещё один аргумент в пользу того, чтобы на проекте всей командой постоянно использовать один пакетный менеджер.

Второй момент - после добавления/изменения поля `overrides` перед переустановкой пакетов надо удалить папку `node_modules` и все `.lock` файлы для того, чтобы
менеджер пакетов заново пересчитал дерево зависимостей и гарантировано установил библиотеки согласно новым правилам переопределения.

_______

Поле `overrides` - довольное мощное средство для ручного переопределения зависимостей. C помощь можно не только задать глобально для всего проекта одну версию библиотеки,
но также можно это сделать для отдельного узла в дереве зависимостей. Это особенно полезно при разработке или тестировании.

Предположим на проекте изначально такое дерево зависимостей:

````
|-- some-ui@1.4
|-- some-forms@1.1
|   `-- some-ui@1.1
|-- some-components@1.2
|   `-- some-ui@1.2
|-- some-lib@2.3
|   |-- some-forms@1.2
|   |   `-- some-ui@1.2
|   |-- some-components@1.3
|   |   `-- some-ui@1.2
|   `-- some-ui@1.3
`-- another-lib@1.5
    |   |-- some-forms@2.0
    |   `-- some-ui@1.8
    |-- some-components@1.4
    |   `-- some-ui@1.3
    `-- some-ui@1.5
````

Мы можем переключить только библиотеку `some-lib` на работу с пакетом `some-ui@1.5-rc34`:

```javascript
  // package.json
  "overrides": {
    "some-lib": {
      "some-ui": "1.5-rc34"
    }
  }
```

А может не просто переназначить в ней зависимость, но и переопределить ее собственную версию:

```javascript
  // package.json
  "overrides": {
    "some-lib": {
      ".": "2.3-rc12"
      "some-ui": "1.5-rc34"
    }
  }
```

Тут нужно упомянуть, что переопределение версий для отдельных узлов с `overrides` в `npm` и `pnpm` работает по-разному (да и синтаксис отличается). Если в примере для `npm` выше
для библиотеки `some-lib` будет использоваться пакет `some-ui@5-rc34` на всю глубину дерева зависимостей, то вот `pnpm` работает только с непосредственными потомками в дереве:

```javascript
  /** Здесь непосредственно в библиотеке "some-lib" будет использован "some-ui@1.5-rc34", а вот пакет "some-form", который также используется в "some-lib", будет по-прежнему
   * работать со своей версией "some-ui" по умолчанию.
   */
  // package.json
  "pnpm": {
    "overrides": {
      "some-lib>some-ui": "1.5-rc34"
    }
  }
  
```

А вот `resolutions` в `yarn` может как переназначить только версии непосредственных потомков в дереве зависимостей, так сделать это на всю глубину ветви:

```javascript
  // package.json
  "resolutions": {
    /** Переназначит версию "some-ui" на всю глубину */
    "some-lib/**/some-ui": "1.5-rc34",
    /** Задаст версию только для пакета "some-ui", непосредственно используемого в "another-lib" */
    "another-lib/some-ui": "1.5-rc34"
  }
```

Также можно переопределять версии не просто внутри какой-то библиотеки, а сделать это для какой-то определенной её версии:

```javascript
  // package.json
  "overrides": {
    "some-forms@1.2": {
      "some-ui": "1.5-rc34"
    }
  }
```

Или даже переопределять зависимости для целого диапазона версий:

```javascript
  // package.json
  "overrides": {
    "some-forms@>=1.2 <1.4": {
      "some-ui": "1.5-rc34"
    }
  }
```


Ну и естественно в `overrides` в значении поля с пакетом, также как и в обычных `dependencies`, для локальной разработки можно указать не номер версии, а путь до локального каталога с библиотекой (надо указать путь до папки с `package.json`):

````
  / my-project
    |-- package.json
    `-- /node_modules/
  / some-ui
    |-- package.json
    `-- index.js

````

```javascript
  // package.json
  "overrides": {
    "some-ui": "file:../some-ui"
  }
```

______

В общем, свойство `overrides` - мощный инструмент ручного переопределения версий пакетом, с помощью которого в проектах можно успешно решать проблемы совместимости библиотек, их разрабатывать и тестировать.

